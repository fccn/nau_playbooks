{% import '_docker_deploy_helper.j2' as helper with context %}
# {{ ansible_managed }}
#
# Docker compose file for redis.
#
version: '3.8'

services:

  redis:
    image: {{ redis_docker_image }}
    command: {{ redis_docker_command }}
    container_name: {{ redis_docker_container_name }}
    restart: always
    ports:
      - target:    {{ redis_docker_port }}
        published: {{ redis_docker_port }}
        protocol:  tcp
        mode:      ingress
    volumes:
      - {{ redis_docker_volume_path }}:/data
    deploy:
      replicas: 1
    ulimits:
      nproc: {{ redis_limit_nproc }}
      nofile:
        soft: {{ redis_limit_no_file_soft }}
        hard: {{ redis_limit_no_file_hard }}
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -p {{ redis_docker_port }} ping | grep PONG"]
      start_period: 30s
      retries: 1000
      interval: 30s
      timeout: 30s
{{ helper.service_configs(service='redis') }}
{{ helper.service_secrets(service='redis') }}

{{ helper.configs() }}
{{ helper.secrets() }}
